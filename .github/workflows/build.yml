name: Deploy

on:
  workflow_dispatch:
  # Uncomment the below line to run the workflow on commit
  push:
    # Run when commits are pushed to mainline branch
    # Set this to the mainline branch you are using
    branches:
      - main

# Set this permission if you are using a Federated Credential.
permissions:
  id-token: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    environment: staging
    # azd build-in variables.
    # This variables are always set by `azd pipeline config`
    # You can set them as global env (apply to all steps) or you can add them to individual steps' environment
    env:
      AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
      AZURE_ENV_NAME: ${{ vars.ENVIRONMENT }}
      AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
      AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
      INDEX_NUMBER: ${{ vars.INDEX_NUMBER }}
      AZURE_CONTAINER_REGISTRY_NAME: ${{ vars.AZURE_CONTAINER_REGISTRY_NAME }}
      AZURE_CONTAINER_REGISTRY_ENDPOINT: ${{ vars.AZURE_CONTAINER_REGISTRY_ENDPOINT }}
      BUILD_TAG: ${{ github.sha }}
      ## Define the additional variables or secrets that are required globally (provision and deploy)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # using the install-azd action
      - name: Install azd
        uses: Azure/setup-azd@v2.1.0

      # Log in with Azure using federated credentials
      - name: Log in with Azure (Federated Credentials)
        uses: azure/login@v1
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}
      
      # Configure azd to use Azure CLI authentication
      - name: Configure AZD to use Azure CLI Auth
        run: |
          azd config set auth.useAzCliAuth "true"
        shell: pwsh
      
      - name: Verify Azure Login
        run: |
          Write-Host "Verifying Azure login..."
          az account show
        shell: pwsh
      
      - name: Create resource group if not exists
        run: |
          $rgName = "${{ env.AZURE_RESOURCE_GROUP }}"
          $location = "${{ env.AZURE_LOCATION }}"
          
          $rg = az group show --name $rgName --output json | ConvertFrom-Json
          
          if ($null -eq $rg) {
            Write-Host "Resource group '$rgName' does not exist. Creating..."
            az group create --name $rgName --location $location
            Write-Host "✓ Resource group '$rgName' created successfully."
          } else {
            Write-Host "✓ Resource group '$rgName' already exists."
          }
        shell: pwsh

      - name: Create or Select AZD Environment
        run: |
          # Check if environment exists
          $envExists = azd env list --output json | ConvertFrom-Json | Where-Object { $_.name -eq "${{ env.AZURE_ENV_NAME }}" }
          
          if ($null -eq $envExists) {
            Write-Host "Creating new AZD environment: ${{ env.AZURE_ENV_NAME }}"
            azd env new "${{ env.AZURE_ENV_NAME }}" --location "${{ env.AZURE_LOCATION }}" --subscription "${{ env.AZURE_SUBSCRIPTION_ID }}"
          } else {
            Write-Host "Selecting existing AZD environment: ${{ env.AZURE_ENV_NAME }}"
            azd env select "${{ env.AZURE_ENV_NAME }}"
          }
        shell: pwsh

      - name: Set AZD Environment Variables
        run: |
          Write-Host "Setting AZD environment variables..."
          azd env set AZURE_SUBSCRIPTION_ID "${{ env.AZURE_SUBSCRIPTION_ID }}"
          azd env set AZURE_LOCATION "${{ env.AZURE_LOCATION }}"
          azd env set AZURE_RESOURCE_GROUP "${{ env.AZURE_RESOURCE_GROUP }}"
          azd env set INDEX_NUMBER "${{ env.INDEX_NUMBER }}"
          azd env set AZURE_CONTAINER_REGISTRY_NAME "${{ env.AZURE_CONTAINER_REGISTRY_NAME }}"
          azd env set AZURE_CONTAINER_REGISTRY_ENDPOINT "${{ env.AZURE_CONTAINER_REGISTRY_ENDPOINT }}"
          azd env set BUILD_TAG "${{ env.BUILD_TAG }}"
          Write-Host "✓ Environment variables set successfully"
        shell: pwsh

      - name: Provision Infrastructure
        run: |
          Write-Host "Provisioning Azure infrastructure..."
          azd provision --no-prompt
        env:
          AZD_INITIAL_ENVIRONMENT_CONFIG: ${{ secrets.AZD_INITIAL_ENVIRONMENT_CONFIG }}
        shell: pwsh

      - name: Deploy Application
        run: |
          Write-Host "Deploying application..."
          azd deploy --no-prompt
        shell: pwsh

      - name: Run Post-Deploy Hook
        if: always()
        run: |
          Write-Host "Running post-deploy hook..." -ForegroundColor Cyan
          # Ensure we're in the correct directory
          Push-Location ${{ github.workspace }}
          
          try {
            # Run the postdeploy hook
            & ./scripts/postdeploy.ps1
          } catch {
            Write-Host "Error running post-deploy hook: $_" -ForegroundColor Red
            exit 1
          } finally {
            Pop-Location
          }
        shell: pwsh

      - name: Deployment Complete
        run: |
          Write-Host "✅ Deployment completed!"
          Write-Host "Environment: ${{ env.AZURE_ENV_NAME }}"
          Write-Host "Location: ${{ env.AZURE_LOCATION }}"
          Write-Host "Resource Group: ${{ env.AZURE_RESOURCE_GROUP }}"
          Write-Host "Commit SHA: ${{ github.sha }}"
        shell: pwsh

