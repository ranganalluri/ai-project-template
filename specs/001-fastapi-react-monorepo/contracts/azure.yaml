# azure.yaml - Azure Developer CLI Configuration
# This file tells `azd` how to deploy the Agentic AI application to Azure

name: agentic-ai
metadata:
  template: fastapi-react-monorepo
  description: Agentic AI - FastAPI backend, React UI, Azure Functions monorepo

# Services to provision and deploy
services:
  ui:
    project: apps/ui
    language: tsx
    host: containerapp
    docker:
      path: ./Dockerfile.ui
      context: .
    
  api:
    project: apps/api
    language: python
    host: containerapp
    docker:
      path: ./Dockerfile.api
      context: .
    depends_on:
      - cosmos
      - servicebus
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - AZURE_COSMOSDB_ENDPOINT=${AZURE_COSMOSDB_ENDPOINT}
      - AZURE_SERVICE_BUS_CONNECTION_STRING=${AZURE_SERVICE_BUS_CONNECTION_STRING}
  
  functions:
    project: apps/functions
    language: python
    host: function
    docker:
      path: ./Dockerfile.functions
      context: .
    depends_on:
      - cosmos
      - servicebus

# Infrastructure resources
infra:
  # Azure Container Apps for UI and API
  - name: containerapp-ui
    type: Microsoft.App/containerApps
    template: infra/resources/containerapp.bicep
    params:
      appName: agentic-ui
      containerImage: ${UI_IMAGE}
      port: 3000

  - name: containerapp-api
    type: Microsoft.App/containerApps
    template: infra/resources/containerapp.bicep
    params:
      appName: agentic-api
      containerImage: ${API_IMAGE}
      port: 8000
      environmentVariables:
        OPENAI_API_KEY: ${OPENAI_API_KEY}
        AZURE_COSMOSDB_ENDPOINT: ${COSMOS_ENDPOINT}
        AZURE_SERVICE_BUS_CONNECTION_STRING: ${SERVICE_BUS_CONNECTION_STRING}

  # Azure Cosmos DB
  - name: cosmos
    type: Microsoft.DocumentDB/databaseAccounts
    template: infra/resources/cosmosdb.bicep
    params:
      accountName: agentic-cosmos-${AZURE_ENV_NAME}
      databaseName: agentic
      containers:
        - id: agents
          partitionKey: /id
        - id: content
          partitionKey: /agent_id
        - id: catalog
          partitionKey: /id
        - id: jobs
          partitionKey: /job_id

  # Azure Service Bus
  - name: servicebus
    type: Microsoft.ServiceBus/namespaces
    template: infra/resources/servicebus.bicep
    params:
      namespaceName: agentic-sb-${AZURE_ENV_NAME}
      queues:
        - name: agentic-jobs
          maxSizeInMegabytes: 1024
        - name: agentic-webhooks
          maxSizeInMegabytes: 256

  # Azure Container Registry
  - name: acr
    type: Microsoft.ContainerRegistry/registries
    template: infra/resources/containerregistry.bicep
    params:
      registryName: agenticcr${AZURE_ENV_NAME}
      skuName: Standard

# Environment variables for local development
env:
  API_URL: http://localhost:8000/api
  VITE_API_URL: http://localhost:8000/api
  OPENAI_API_KEY: ${OPENAI_API_KEY}
  AZURE_COSMOSDB_ENDPOINT: https://localhost:8081
  AZURE_SERVICE_BUS_CONNECTION_STRING: UseDevelopmentStorage=true
