openapi: 3.1.0
info:
  title: Agentic AI API
  description: |
    FastAPI backend for Agentic AI monorepo.
    
    **Architecture Flow:**
    - UI (React) calls FastAPI endpoints
    - FastAPI integrates with OpenAI for LLM capabilities
    - Azure Functions handle background processing via Service Bus queue
    - Cosmos DB stores all persistent data
    
  version: 1.0.0
  contact:
    name: Datalance AI Team
  license:
    name: MIT

servers:
  - url: http://localhost:8000
    description: Local development server
  - url: https://api.datalance.dev
    description: Production server

tags:
  - name: Health
    description: Service health checks
  - name: Agents
    description: Agent management endpoints
  - name: Content
    description: Content management endpoints
  - name: Catalog
    description: Catalog browsing endpoints
  - name: AI
    description: OpenAI integration endpoints (chat, embeddings, batch)

paths:
  /api/health:
    get:
      summary: Health check endpoint
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ok"
                  version:
                    type: string
                    example: "1.0.0"
                  timestamp:
                    type: string
                    format: date-time

  /api/agents:
    get:
      summary: List all agents
      tags:
        - Agents
      parameters:
        - name: skip
          in: query
          schema:
            type: integer
            default: 0
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: status
          in: query
          schema:
            type: string
            enum: [active, inactive, processing]
      responses:
        '200':
          description: List of agents
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Agent'

    post:
      summary: Create a new agent
      tags:
        - Agents
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentCreate'
      responses:
        '201':
          description: Agent created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Agent'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/agents/{agent_id}:
    get:
      summary: Get agent by ID
      tags:
        - Agents
      parameters:
        - name: agent_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Agent details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Agent'
        '404':
          description: Agent not found

    put:
      summary: Update agent
      tags:
        - Agents
      parameters:
        - name: agent_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentUpdate'
      responses:
        '200':
          description: Agent updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Agent'
        '404':
          description: Agent not found

    delete:
      summary: Delete agent
      tags:
        - Agents
      parameters:
        - name: agent_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Agent deleted
        '404':
          description: Agent not found

  /api/content:
    get:
      summary: List content items
      tags:
        - Content
      parameters:
        - name: agent_id
          in: query
          schema:
            type: string
        - name: category
          in: query
          schema:
            type: string
        - name: skip
          in: query
          schema:
            type: integer
            default: 0
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: List of content items
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ContentItem'

    post:
      summary: Create new content
      tags:
        - Content
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ContentCreate'
      responses:
        '201':
          description: Content created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContentItem'
        '400':
          description: Invalid input

  /api/content/{content_id}:
    get:
      summary: Get content by ID
      tags:
        - Content
      parameters:
        - name: content_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Content details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContentItem'
        '404':
          description: Content not found

    put:
      summary: Update content
      tags:
        - Content
      parameters:
        - name: content_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ContentUpdate'
      responses:
        '200':
          description: Content updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContentItem'
        '404':
          description: Content not found

    delete:
      summary: Delete content
      tags:
        - Content
      parameters:
        - name: content_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Content deleted
        '404':
          description: Content not found

  /api/catalog:
    get:
      summary: List catalog entries
      tags:
        - Catalog
      parameters:
        - name: search
          in: query
          schema:
            type: string
        - name: tags
          in: query
          schema:
            type: array
            items:
              type: string
        - name: min_rating
          in: query
          schema:
            type: number
            minimum: 0
            maximum: 5
      responses:
        '200':
          description: List of catalog entries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CatalogEntry'

  /api/catalog/{entry_id}:
    get:
      summary: Get catalog entry by ID
      tags:
        - Catalog
      parameters:
        - name: entry_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Catalog entry details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CatalogEntry'
        '404':
          description: Entry not found

  /api/ai/chat:
    post:
      summary: Send message to OpenAI chat completion
      tags:
        - AI
      description: |
        Send a message and get a response using OpenAI's chat completion API.
        
        **Example request:**
        ```json
        {
          "messages": [
            {"role": "system", "content": "You are a helpful assistant"},
            {"role": "user", "content": "What is machine learning?"}
          ],
          "model": "gpt-4",
          "temperature": 0.7,
          "max_tokens": 500
        }
        ```
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatCompletionRequest'
      responses:
        '200':
          description: Chat completion response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatCompletionResponse'
        '400':
          description: Invalid request parameters
        '401':
          description: OpenAI API key invalid
        '429':
          description: Rate limit exceeded

  /api/ai/embeddings:
    post:
      summary: Create text embedding using OpenAI
      tags:
        - AI
      description: |
        Generate vector embeddings for text using OpenAI's embedding model.
        
        **Example request:**
        ```json
        {
          "text": "The quick brown fox jumps over the lazy dog",
          "model": "text-embedding-3-small"
        }
        ```
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EmbeddingRequest'
      responses:
        '200':
          description: Embedding created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmbeddingResponse'
        '400':
          description: Invalid input

  /api/ai/batch:
    post:
      summary: Queue batch AI job for async processing
      tags:
        - AI
      description: |
        Queue a background job (processed by Azure Functions) for AI batch operations.
        UI should poll /api/jobs/{job_id} for completion.
        
        **Example:**
        ```json
        {
          "job_type": "embeddings_batch",
          "items": [
            {"text": "Item 1"},
            {"text": "Item 2"}
          ]
        }
        ```
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchJobRequest'
      responses:
        '202':
          description: Job queued for processing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchJobResponse'
        '400':
          description: Invalid request

  /api/jobs/{job_id}:
    get:
      summary: Get async job status and results
      tags:
        - AI
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Job status and results (if complete)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobStatusResponse'
        '404':
          description: Job not found

components:
  schemas:
    Agent:
      type: object
      properties:
        id:
          type: string
          example: "agent-001"
        name:
          type: string
          example: "Data Analyzer"
        description:
          type: string
          example: "Agent for analyzing datasets"
        status:
          type: string
          enum: [active, inactive, processing]
        configuration:
          type: object
          example: {}
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required:
        - id
        - name
        - status
        - created_at
        - updated_at

    AgentCreate:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
        description:
          type: string
          maxLength: 2000
        status:
          type: string
          enum: [active, inactive]
          default: "active"
        configuration:
          type: object
      required:
        - name

    AgentUpdate:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
        description:
          type: string
          maxLength: 2000
        status:
          type: string
          enum: [active, inactive, processing]
        configuration:
          type: object

    ContentItem:
      type: object
      properties:
        id:
          type: string
        agent_id:
          type: string
        title:
          type: string
        body:
          type: string
        category:
          type: string
        metadata:
          type: object
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required:
        - id
        - agent_id
        - title
        - created_at

    ContentCreate:
      type: object
      properties:
        agent_id:
          type: string
        title:
          type: string
          minLength: 1
          maxLength: 500
        body:
          type: string
          maxLength: 10000
        category:
          type: string
        metadata:
          type: object
      required:
        - agent_id
        - title

    ContentUpdate:
      type: object
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 500
        body:
          type: string
          maxLength: 10000
        category:
          type: string
        metadata:
          type: object

    CatalogEntry:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        tags:
          type: array
          items:
            type: string
        rating:
          type: number
          minimum: 0
          maximum: 5
        version:
          type: string
      required:
        - id
        - name

    ChatCompletionRequest:
      type: object
      properties:
        messages:
          type: array
          items:
            type: object
            properties:
              role:
                type: string
                enum: [system, user, assistant]
              content:
                type: string
        model:
          type: string
          default: "gpt-4"
          enum: [gpt-4, gpt-4-turbo, gpt-3.5-turbo]
        temperature:
          type: number
          minimum: 0
          maximum: 2
          default: 0.7
        max_tokens:
          type: integer
          default: 500
      required:
        - messages

    ChatCompletionResponse:
      type: object
      properties:
        content:
          type: string
          description: Response text from OpenAI
        model:
          type: string
        tokens_used:
          type: object
          properties:
            prompt:
              type: integer
            completion:
              type: integer
            total:
              type: integer
        finish_reason:
          type: string
          enum: [stop, length, content_filter]

    EmbeddingRequest:
      type: object
      properties:
        text:
          type: string
        model:
          type: string
          default: "text-embedding-3-small"
      required:
        - text

    EmbeddingResponse:
      type: object
      properties:
        embedding:
          type: array
          items:
            type: number
        model:
          type: string
        dimension:
          type: integer

    BatchJobRequest:
      type: object
      properties:
        job_type:
          type: string
          enum: [embeddings_batch, chat_batch, content_processor]
        items:
          type: array
          items:
            type: object
        config:
          type: object
      required:
        - job_type
        - items

    BatchJobResponse:
      type: object
      properties:
        job_id:
          type: string
        status:
          type: string
          enum: [queued, processing, completed, failed]
        created_at:
          type: string
          format: date-time
        estimated_completion:
          type: string
          format: date-time

    JobStatusResponse:
      type: object
      properties:
        job_id:
          type: string
        status:
          type: string
          enum: [queued, processing, completed, failed]
        progress:
          type: object
          properties:
            total:
              type: integer
            completed:
              type: integer
            percentage:
              type: number
        results:
          type: object
          description: Results (only populated when status=completed)
        error:
          type: string
          description: Error message (only if status=failed)
        created_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        detail:
          type: string
        status:
          type: integer
      required:
        - error
        - status
